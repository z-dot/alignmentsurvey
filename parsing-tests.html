<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time/Probability Parsing Tests</title>
    <style>
        body {
            font-family: 'et-book', 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #FFFFF8;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .test-pass {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        
        .test-fail {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .test-input {
            margin: 5px 0;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 200px;
        }
        
        .interactive-test {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #2A623D;
            border-radius: 4px;
            background-color: white;
        }
        
        button {
            padding: 8px 16px;
            background-color: #2A623D;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background-color: #1f4d30;
        }
        
        .summary {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .summary.pass {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        
        .summary.fail {
            background-color: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <h1>Time/Probability Parsing Tests</h1>
    
    <div class="test-section">
        <h2>Time Parsing Tests</h2>
        <div id="time-tests"></div>
    </div>
    
    <div class="test-section">
        <h2>Probability Parsing Tests</h2>
        <div id="probability-tests"></div>
    </div>
    
    <div class="test-section">
        <h2>Time Formatting Tests</h2>
        <div id="time-formatting-tests"></div>
    </div>
    
    <div class="test-section">
        <h2>Round-trip Consistency Tests</h2>
        <div id="roundtrip-tests"></div>
    </div>
    
    <div class="test-section">
        <h2>Interactive Testing</h2>
        <div class="interactive-test">
            <h3>Time Parser</h3>
            <input type="text" id="time-input" class="test-input" placeholder="e.g., 2.5 years, 6 months">
            <button onclick="testTimeInput()">Parse Time</button>
            <div id="time-result"></div>
        </div>
        
        <div class="interactive-test">
            <h3>Probability Parser</h3>
            <input type="text" id="prob-input" class="test-input" placeholder="e.g., 75%, 0.75">
            <button onclick="testProbInput()">Parse Probability</button>
            <div id="prob-result"></div>
        </div>
    </div>
    
    <button onclick="runAllTests()">Run All Tests</button>
    <div id="test-summary"></div>
    
    <script src="metalog-utils.js"></script>
    <script>
        const metalogUtils = new MetalogUtils();
        
        // Test cases for time parsing
        const timeTestCases = [
            // Basic units
            { input: "1 day", expected: 1/365.25, description: "1 day" },
            { input: "7 days", expected: 7/365.25, description: "7 days" },
            { input: "1 week", expected: 1/52.18, description: "1 week" },
            { input: "2 weeks", expected: 2/52.18, description: "2 weeks" },
            { input: "1 month", expected: 1/12, description: "1 month" },
            { input: "6 months", expected: 0.5, description: "6 months" },
            { input: "1 year", expected: 1, description: "1 year" },
            { input: "2.5 years", expected: 2.5, description: "2.5 years" },
            { input: "1 decade", expected: 10, description: "1 decade" },
            { input: "5 decades", expected: 50, description: "5 decades" },
            { input: "1 century", expected: 100, description: "1 century" },
            
            // Variations in formatting
            { input: "1.5months", expected: 1.5/12, description: "1.5months (no space)" },
            { input: "  2 Years  ", expected: 2, description: "2 Years (whitespace, caps)" },
            { input: "3.14159 days", expected: 3.14159/365.25, description: "π days" },
            
            // Default to years
            { input: "5", expected: 5, description: "5 (no unit, defaults to years)" },
            { input: "0.5", expected: 0.5, description: "0.5 (no unit, defaults to years)" },
            
            // Edge cases and errors
            { input: "0 days", expected: null, description: "0 days (should be null)" },
            { input: "-1 year", expected: null, description: "-1 year (should be null)" },
            { input: "abc", expected: null, description: "abc (invalid)" },
            { input: "", expected: null, description: "empty string" },
            { input: "NaN years", expected: null, description: "NaN years" },
        ];
        
        // Test cases for time formatting
        const timeFormattingTestCases = [
            // Days
            { input: 1/365.25, expectedPattern: /1 day/, description: "1 day" },
            { input: 7/365.25, expectedPattern: /7 days/, description: "1 week in days" },
            { input: 10/365.25, expectedPattern: /10 days/, description: "10 days" },
            
            // Months  
            { input: 1/12, expectedPattern: /1 month/, description: "1 month" },
            { input: 2/12, expectedPattern: /2\.0 months/, description: "2 months" },
            { input: 6/12, expectedPattern: /6\.0 months/, description: "6 months" },
            { input: 11/12, expectedPattern: /11\.0 months/, description: "11 months" },
            
            // Years
            { input: 1, expectedPattern: /1 year/, description: "1 year" },
            { input: 2.5, expectedPattern: /2\.5 years/, description: "2.5 years" },
            { input: 9.7, expectedPattern: /9\.7 years/, description: "9.7 years" },
            { input: 15, expectedPattern: /15 years/, description: "15 years" },
            { input: 50, expectedPattern: /50 years/, description: "50 years" },
            
            // Centuries
            { input: 100, expectedPattern: /1 century/, description: "1 century" },
            { input: 250, expectedPattern: /2\.5 centuries/, description: "2.5 centuries" },
        ];
        
        // Test cases for semantic consistency (parse → format → parse should be equivalent)
        const roundTripTestCases = [
            // These should maintain semantic equivalence
            { input: "1 year", description: "1 year" },
            { input: "12 months", description: "12 months (should be ~1 year)" },
            { input: "365 days", description: "365 days (should be ~1 year)" },
            { input: "2.5 years", description: "2.5 years" },
            { input: "30 months", description: "30 months (should be ~2.5 years)" },
            { input: "1 decade", description: "1 decade" },
            { input: "1 century", description: "1 century" },
            { input: "6 months", description: "6 months" },
            { input: "18 months", description: "18 months" },
            { input: "100 years", description: "100 years" },
        ];

        // Test cases for probability parsing
        const probTestCases = [
            // Percentage format
            { input: "50%", expected: 0.5, description: "50%" },
            { input: "100%", expected: 1.0, description: "100%" },
            { input: "0%", expected: 0.0, description: "0%" },
            { input: "75.5%", expected: 0.755, description: "75.5%" },
            { input: "150%", expected: 1.0, description: "150% (clamped to 1.0)" },
            
            // Decimal format
            { input: "0.5", expected: 0.5, description: "0.5" },
            { input: "1.0", expected: 1.0, description: "1.0" },
            { input: "0.0", expected: 0.0, description: "0.0" },
            { input: "0.755", expected: 0.755, description: "0.755" },
            { input: "1.5", expected: 1.0, description: "1.5 (clamped to 1.0)" },
            { input: "-0.1", expected: 0.0, description: "-0.1 (clamped to 0.0)" },
            
            // Edge cases
            { input: "  75%  ", expected: 0.75, description: "75% (with whitespace)" },
            { input: "abc", expected: null, description: "abc (invalid)" },
            { input: "", expected: null, description: "empty string" },
            { input: "NaN%", expected: null, description: "NaN%" },
        ];
        
        function runTimeTests() {
            const container = document.getElementById('time-tests');
            container.innerHTML = '';
            let passCount = 0;
            let totalCount = timeTestCases.length;
            
            timeTestCases.forEach(testCase => {
                const result = metalogUtils.parseTimeInput(testCase.input);
                const passed = (result === null && testCase.expected === null) || 
                              (result !== null && testCase.expected !== null && Math.abs(result - testCase.expected) < 1e-10);
                
                if (passed) passCount++;
                
                const div = document.createElement('div');
                div.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
                div.innerHTML = `
                    <strong>${testCase.description}</strong><br>
                    Input: "${testCase.input}" → Expected: ${testCase.expected} → Got: ${result}
                    ${passed ? '✓ PASS' : '✗ FAIL'}
                `;
                container.appendChild(div);
            });
            
            return { passCount, totalCount };
        }
        
        function runProbabilityTests() {
            const container = document.getElementById('probability-tests');
            container.innerHTML = '';
            let passCount = 0;
            let totalCount = probTestCases.length;
            
            probTestCases.forEach(testCase => {
                const result = metalogUtils.parseProbabilityInput(testCase.input);
                const passed = (result === null && testCase.expected === null) || 
                              (result !== null && testCase.expected !== null && Math.abs(result - testCase.expected) < 1e-10);
                
                if (passed) passCount++;
                
                const div = document.createElement('div');
                div.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
                div.innerHTML = `
                    <strong>${testCase.description}</strong><br>
                    Input: "${testCase.input}" → Expected: ${testCase.expected} → Got: ${result}
                    ${passed ? '✓ PASS' : '✗ FAIL'}
                `;
                container.appendChild(div);
            });
            
            return { passCount, totalCount };
        }
        
        function runTimeFormattingTests() {
            const container = document.getElementById('time-formatting-tests');
            container.innerHTML = '';
            let passCount = 0;
            let totalCount = timeFormattingTestCases.length;
            
            timeFormattingTestCases.forEach(testCase => {
                const result = metalogUtils.formatTime(testCase.input);
                const passed = testCase.expectedPattern.test(result);
                
                if (passed) passCount++;
                
                const div = document.createElement('div');
                div.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
                div.innerHTML = `
                    <strong>${testCase.description}</strong><br>
                    Input: ${testCase.input} years → Expected pattern: ${testCase.expectedPattern} → Got: "${result}"
                    ${passed ? '✓ PASS' : '✗ FAIL'}
                `;
                container.appendChild(div);
            });
            
            return { passCount, totalCount };
        }
        
        function runRoundTripTests() {
            const container = document.getElementById('roundtrip-tests');
            container.innerHTML = '';
            let passCount = 0;
            let totalCount = roundTripTestCases.length;
            
            roundTripTestCases.forEach(testCase => {
                // Parse input
                const parsed1 = metalogUtils.parseTimeInput(testCase.input);
                if (parsed1 === null) {
                    const div = document.createElement('div');
                    div.className = 'test-result test-fail';
                    div.innerHTML = `
                        <strong>${testCase.description}</strong><br>
                        Input: "${testCase.input}" → Parse failed (returned null)
                        ✗ FAIL
                    `;
                    container.appendChild(div);
                    return;
                }
                
                // Format the parsed value
                const formatted = metalogUtils.formatTime(parsed1);
                
                // Parse the formatted value
                const parsed2 = metalogUtils.parseTimeInput(formatted);
                
                // Check semantic equivalence (within 1% tolerance)
                const tolerance = 0.01; // 1% tolerance
                const passed = Math.abs(parsed1 - parsed2) / parsed1 < tolerance;
                
                if (passed) passCount++;
                
                const div = document.createElement('div');
                div.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
                div.innerHTML = `
                    <strong>${testCase.description}</strong><br>
                    "${testCase.input}" → ${parsed1.toFixed(6)} years → "${formatted}" → ${parsed2.toFixed(6)} years<br>
                    Difference: ${Math.abs(parsed1 - parsed2).toFixed(6)} years (${((Math.abs(parsed1 - parsed2) / parsed1) * 100).toFixed(2)}%)
                    ${passed ? '✓ PASS' : '✗ FAIL'}
                `;
                container.appendChild(div);
            });
            
            return { passCount, totalCount };
        }
        
        function runAllTests() {
            const timeResults = runTimeTests();
            const probResults = runProbabilityTests();
            const formattingResults = runTimeFormattingTests();
            const roundTripResults = runRoundTripTests();
            
            const totalPass = timeResults.passCount + probResults.passCount + 
                            formattingResults.passCount + roundTripResults.passCount;
            const totalTests = timeResults.totalCount + probResults.totalCount + 
                             formattingResults.totalCount + roundTripResults.totalCount;
            const allPassed = totalPass === totalTests;
            
            const summary = document.getElementById('test-summary');
            summary.className = `summary ${allPassed ? 'pass' : 'fail'}`;
            summary.innerHTML = `
                <h3>Test Summary</h3>
                <p>Time parsing: ${timeResults.passCount}/${timeResults.totalCount} tests passed</p>
                <p>Probability parsing: ${probResults.passCount}/${probResults.totalCount} tests passed</p>
                <p>Time formatting: ${formattingResults.passCount}/${formattingResults.totalCount} tests passed</p>
                <p>Round-trip consistency: ${roundTripResults.passCount}/${roundTripResults.totalCount} tests passed</p>
                <p><strong>Overall: ${totalPass}/${totalTests} tests passed ${allPassed ? '🎉' : '❌'}</strong></p>
            `;
        }
        
        function testTimeInput() {
            const input = document.getElementById('time-input').value;
            const result = metalogUtils.parseTimeInput(input);
            const formatted = result !== null ? metalogUtils.formatTime(result) : 'Invalid';
            
            document.getElementById('time-result').innerHTML = `
                <strong>Result:</strong> ${result} years<br>
                <strong>Formatted:</strong> ${formatted}
            `;
        }
        
        function testProbInput() {
            const input = document.getElementById('prob-input').value;
            const result = metalogUtils.parseProbabilityInput(input);
            const formatted = result !== null ? `${(result * 100).toFixed(1)}%` : 'Invalid';
            
            document.getElementById('prob-result').innerHTML = `
                <strong>Result:</strong> ${result}<br>
                <strong>Formatted:</strong> ${formatted}
            `;
        }
        
        // Run tests on page load
        window.addEventListener('load', runAllTests);
    </script>
</body>
</html>